package com.knightonline.shared.persistence.cache;

import java.net.URL;
import java.util.Properties;

import net.sf.ehcache.CacheManager;

import org.apache.log4j.Logger;
import org.hibernate.cache.CacheDataDescription;
import org.hibernate.cache.CacheException;
import org.hibernate.cache.CollectionRegion;
import org.hibernate.cache.EhCache;
import org.hibernate.cache.EntityRegion;
import org.hibernate.cache.QueryResultsRegion;
import org.hibernate.cache.RegionFactory;
import org.hibernate.cache.Timestamper;
import org.hibernate.cache.TimestampsRegion;
import org.hibernate.cache.impl.bridge.CollectionRegionAdapter;
import org.hibernate.cache.impl.bridge.EntityRegionAdapter;
import org.hibernate.cache.impl.bridge.QueryResultsRegionAdapter;
import org.hibernate.cache.impl.bridge.TimestampsRegionAdapter;
import org.hibernate.cfg.Environment;
import org.hibernate.cfg.Settings;
import org.hibernate.util.ConfigHelper;
import org.hibernate.util.StringHelper;

public class EhcacheReqionFactory implements RegionFactory
{
	private static final Logger log = Logger.getLogger(EhcacheReqionFactory.class);

	public static CacheManager manager = null;
	
	protected Settings settings = null;
	protected Properties set_properties = null;

	public EhcacheReqionFactory(Properties properties)
	{
		this.set_properties = properties;
	}

	protected EhCache buildCache(String name, Properties properties) throws CacheException
	{
		try
		{
			net.sf.ehcache.Cache cache = manager.getCache(name);
			
			if (cache == null)
			{
				log.warn(String.format("Could not find configuration [%s]; using defaults.", name));
				manager.addCache(name);
				
				cache = manager.getCache(name);
				log.debug("started EHCache region: " + name);
			}
			
			return new EhCache(cache);
		}
		
		catch (net.sf.ehcache.CacheException e)
		{
			throw new CacheException(e);
		}
	}

	@Override
	public long nextTimestamp()
	{
		return Timestamper.next();
	}

	@Override
	public void start(Settings i_settings, Properties properties) throws CacheException
	{
		this.settings = i_settings;
		
		if (manager != null)
		{
			log.warn("Attempt to restart an already started EhCacheProvider. Use sessionFactory.close() "
					+ " between repeated calls to buildSessionFactory. Using previously created EhCacheProvider."
					+ " If this behaviour is required, consider using net.sf.ehcache.hibernate.SingletonEhCacheProvider.");
			return;
		}
		
		try
		{
			String configurationResourceName = null;
			
			if (properties != null)
			{
				configurationResourceName = (String) properties.get(Environment.CACHE_PROVIDER_CONFIG);
			}
			
			if (StringHelper.isEmpty(configurationResourceName))
			{
				manager = new CacheManager();
			}
			
			else
			{
				URL url = loadResource(configurationResourceName);
				manager = new CacheManager(url);
			}
		}
		
		catch (net.sf.ehcache.CacheException e)
		{
			if (e.getMessage().startsWith("Cannot parseConfiguration CacheManager. Attempt to create a new instance of "
					+ "CacheManager using the diskStorePath"))
			{
				throw new CacheException(
						"Attempt to restart an already started EhCacheProvider. Use sessionFactory.close() "
								+ " between repeated calls to buildSessionFactory. Consider using net.sf.ehcache.hibernate.SingletonEhCacheProvider.",
						e);
			}
			throw e;
		}
	}

	private URL loadResource(String configurationResourceName)
	{
		URL url = ConfigHelper.locateConfig(configurationResourceName);
		
		if (log.isDebugEnabled())
		{
			log.debug("Creating EhCacheProvider from a specified resource: " + configurationResourceName
					+ " Resolved to URL: " + url);
		}
		return url;
	}

	/**
	 * Callback to perform any necessary cleanup of the underlying cache
	 * implementation during SessionFactory.close().
	 */
	@Override
	public void stop()
	{
		if (manager != null)
		{
			manager.shutdown();
			manager = null;
		}
	}

	@Override
	public boolean isMinimalPutsEnabledByDefault()
	{
		return false;
	}

	@Override
	public EntityRegion buildEntityRegion(String regionName, Properties properties, CacheDataDescription metadata) throws CacheException
	{
		return new EntityRegionAdapter(buildCache(regionName, properties), this.settings, metadata);
	}

	@Override
	public CollectionRegion buildCollectionRegion(String regionName, Properties properties, CacheDataDescription metadata) throws CacheException
	{
		return new CollectionRegionAdapter(buildCache(regionName, properties), this.settings, metadata);
	}

	@Override
	public QueryResultsRegion buildQueryResultsRegion(String regionName, Properties properties) throws CacheException
	{
		return new QueryResultsRegionAdapter(buildCache(regionName, properties), this.settings)
		{
			// empty
		};
	}

	@Override
	public TimestampsRegion buildTimestampsRegion(String regionName, Properties properties) throws CacheException
	{
		return new TimestampsRegionAdapter(buildCache(regionName, properties), this.settings)
		{
			// empty
		};
	}
}
